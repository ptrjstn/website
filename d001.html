<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>drop 02 — Primes</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <main class="wrap">
    <pre class="ascii" data-ascii="header" data-title="ptrjstn"></pre>

    <h1 class="sr-only">ptrjstn</h1>

    <section class="page-content">
    <p class="text">finde die 5-stellige zahl mit quersumme <strong id="targetSum"></strong>.</p>

    <div class="game">
      <div class="board" id="board" aria-label="Primes board"></div>

      <div class="status">
        <span class="muted" id="info"></span>
        <span class="muted" id="feedback"></span>
      </div>
    </div>

    <p class="text">
      <a href="index.html">← back</a>
      <span class="muted">/</span>
      <a href="#" id="newGame">new</a>
    </p>
    </section>

    <pre class="ascii" aria-hidden="true" data-ascii="line"></pre>

    <div id="sharedMeta"></div>

    <div id="sharedFooter"></div>
  </main>

  <script src="fragments.js"></script>
  <script src="shell.js"></script>

  <script>
    const boardEl = document.getElementById("board");
    const infoEl = document.getElementById("info");
    const feedbackEl = document.getElementById("feedback");
    const newGame = document.getElementById("newGame");
    const targetSumEl = document.getElementById("targetSum");

    const ROWS = 5;
    const COLS = 5;
    let answer = "";
    let row = 0;
    let gameOver = false;

    function clearBoard() {
      boardEl.innerHTML = "";
      for (let r = 0; r < ROWS; r++) {
        const rowEl = document.createElement("div");
        rowEl.className = "row";
        rowEl.dataset.row = String(r);
        for (let c = 0; c < COLS; c++) {
          const cell = document.createElement("input");
          cell.className = "cell";
          cell.type = "text";
          cell.inputMode = "numeric";
          cell.maxLength = 1;
          cell.dataset.row = String(r);
          cell.dataset.col = String(c);
          cell.setAttribute("aria-label", `row ${r + 1} col ${c + 1}`);
          rowEl.appendChild(cell);
        }
        boardEl.appendChild(rowEl);
      }
    }

    function setActiveRow(r) {
      const all = boardEl.querySelectorAll(".cell");
      all.forEach((el) => {
        const rr = Number(el.dataset.row);
        el.disabled = rr !== r || gameOver;
      });
      const first = boardEl.querySelector(`.cell[data-row="${r}"][data-col="0"]`);
      if (first) first.focus();
    }

    function getRowValues(r) {
      const cells = boardEl.querySelectorAll(`.cell[data-row="${r}"]`);
      return Array.from(cells).map((c) => c.value);
    }

    function applyFeedback(r, guess) {
      const cells = boardEl.querySelectorAll(`.cell[data-row="${r}"]`);
      const target = answer.split("");
      const counts = {};
      target.forEach((d) => { counts[d] = (counts[d] || 0) + 1; });

      guess.forEach((d, i) => {
        if (d === target[i]) {
          cells[i].classList.add("hit");
          counts[d] -= 1;
        }
      });

      guess.forEach((d, i) => {
        if (cells[i].classList.contains("hit")) return;
        if (counts[d] > 0) {
          cells[i].classList.add("near");
          counts[d] -= 1;
        } else {
          cells[i].classList.add("miss");
        }
      });
    }

    function lockRow(r) {
      const cells = boardEl.querySelectorAll(`.cell[data-row="${r}"]`);
      cells.forEach((c) => (c.disabled = true));
    }

    function submitRow() {
      const guess = getRowValues(row);
      if (guess.some((d) => d === "")) return;
      applyFeedback(row, guess);
      lockRow(row);

      if (guess.join("") === answer) {
        feedbackEl.textContent = "";
        gameOver = true;
        setActiveRow(row);
        return;
      }

      row += 1;
      if (row >= ROWS) {
        feedbackEl.textContent = `vorbei. ${answer}`;
        gameOver = true;
        setActiveRow(row);
        return;
      }

      setActiveRow(row);
    }

    function handleInput(e) {
      const el = e.target;
      if (!el.classList.contains("cell")) return;
      const v = el.value.replace(/[^0-9]/g, "");
      el.value = v.slice(0, 1);
      if (el.value) {
        const col = Number(el.dataset.col);
        const next = boardEl.querySelector(`.cell[data-row="${row}"][data-col="${col + 1}"]`);
        if (next) next.focus();
      }
      submitRow();
    }

    function handleKeydown(e) {
      const el = e.target;
      if (!el.classList.contains("cell")) return;
      const col = Number(el.dataset.col);
      if (e.key === "Backspace" && !el.value && col > 0) {
        const prev = boardEl.querySelector(`.cell[data-row="${row}"][data-col="${col - 1}"]`);
        if (prev) prev.focus();
      }
      if (e.key === "Enter") {
        e.preventDefault();
        submitRow();
      }
    }

    function handlePaste(e) {
      const el = e.target;
      if (!el.classList.contains("cell")) return;
      const text = (e.clipboardData || window.clipboardData).getData("text");
      if (!text) return;
      const digits = text.replace(/[^0-9]/g, "").slice(0, COLS);
      if (!digits) return;
      e.preventDefault();
      const startCol = Number(el.dataset.col);
      for (let i = 0; i < digits.length; i++) {
        const cell = boardEl.querySelector(`.cell[data-row="${row}"][data-col="${startCol + i}"]`);
        if (cell) cell.value = digits[i];
      }
      submitRow();
    }

    function digitSum(s) {
      return s.split("").reduce((acc, d) => acc + Number(d || 0), 0);
    }

    function randomFiveDigit() {
      return String(Math.floor(Math.random() * 90000) + 10000);
    }

    function startGame() {
      answer = randomFiveDigit();
      targetSumEl.textContent = String(digitSum(answer));
      row = 0;
      gameOver = false;
      feedbackEl.textContent = "";
      infoEl.textContent = "";
      clearBoard();
      setActiveRow(0);
    }

    boardEl.addEventListener("input", handleInput);
    boardEl.addEventListener("keydown", handleKeydown);
    boardEl.addEventListener("paste", handlePaste);

    newGame.addEventListener("click", (e) => {
      e.preventDefault();
      startGame();
    });

    startGame();
  </script>

  <style>
    :root{
      --game-card: transparent;
      --game-line: #586e75;
      --hit: #859900;
      --near: #cb4b16;
      --miss: #93a1a1;
    }

    body{
      background: var(--bg);
      color: var(--ink);
      font-family: var(--typewriter);
    }

    .ascii{
      font-family: var(--typewriter);
      font-size: 13px;
      line-height: 1.2;
      margin-bottom: 16px;
    }
    .page-content{
      margin: 42px 0;
    }

    .text{
      color: var(--ink);
      font-size: 15px;
    }

    .page-content > p.text:first-of-type{
      text-align: center;
    }

    .game{
      margin: 12px auto 14px;
      padding: 0;
      background: transparent;
      border: 0;
      box-shadow: none;
      display: block;
      width: fit-content;
      max-width: 100%;
    }

    .board{
      display: grid;
      grid-template-rows: repeat(5, 1fr);
      gap: 6px;
      width: min(300px, calc(100vw - 48px));
    }

    .row{
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
    }

    .cell{
      width: 100%;
      aspect-ratio: 1 / 1;
      border: 1px solid var(--game-line);
      border-radius: 0;
      font-size: 17px;
      text-align: center;
      font-weight: 600;
      color: var(--ink);
      outline: none;
      background: #eee8d5;
      transition: border-color 120ms ease, background 120ms ease;
      font-family: var(--typewriter);
    }

    .cell:focus{
      border-color: var(--link);
      box-shadow: 0 0 0 2px rgba(38,139,210,0.32);
    }

    .cell.hit{
      border-color: var(--hit);
      background: var(--hit);
      color: #fff;
    }

    .cell.near{
      border-color: var(--near);
      background: var(--near);
      color: #fdf6e3;
    }

    .cell.miss{
      border-color: var(--game-line);
      background: var(--miss);
      color: #073642;
    }

    .status{
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }

    a{
      color: var(--link);
      text-decoration: underline;
    }

    @media (max-width: 520px){
      .wrap{
        padding: 16px 14px 32px;
      }

      .ascii{
        font-size: 12px;
      }

      .cell{
        font-size: 19px;
      }
    }
  </style>
</body>
</html>
